<!doctype html>
<html>

<head>
    <title>Kubernetes 的基本概念和术语 K8s Basic Concepts and Terminology // Realjf&#39;s blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.101.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="realjf" />
    <meta name="description"
        content="" />
    <base href="https://realjf.io/" />
    <link rel="stylesheet" href="https://realjf.io/css/main.min.0b68cfbaea60634bb6fd6850a294eb3f8c1a7bd7ff87d5f83e496b6223fe53d8.css" />
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
    
    <script src="./js/highlight.pack.js"> </script>
    
    <link rel="stylesheet" href="./css/monokai-sublime.css">
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    
    <header class="app-header">
        <a href="/"><img class="app-header-avatar" src="./avatar.jpg" /></a>
        <h1>Realjf&#39;s blog</h1>
        <p>认识自己，接受自己，忘记自己，追随自己的灵魂</p>
        <div class="app-header-social">
            
            <a target="_blank" href="https://github.com/realjf"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
            
            <a target="_blank" href="https://twitter.com/realjf2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
            
        </div>
        <div>
            <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=56j9sfhb0ei&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>
        </div>
    </header>
    <main class="app-container">
        <nav class="sidebar-nav">
    
    
            <a class="sidebar-nav-item" href="/" title="首页"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-home">
  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg> 首页</a>
    
            <a class="sidebar-nav-item" href="/posts/" title="归档"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-archive">
  <polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line>
</svg> 归档</a>
    
            <a class="sidebar-nav-item" href="/tags/" title="标签"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg> 标签</a>
    
            <a class="sidebar-nav-item" href="/categories/" title="分类"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg> 分类</a>
    
            <a class="sidebar-nav-item" href="/series/" title="系列"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg> 系列</a>
    
</nav>
        <style>
    @media screen and (max-width: 500px) {
        .search{
             
            text-align: center;
        }

        .search input{
            width: 100%;
        }

        .search button{
             
        }
    }
     
    @media screen and (min-width: 320px) {
        .search{
            width: 100%;
            text-align: center;
        }

        .search input{
            width: 50%;
        }
    }

     
    .search{
        margin: auto;
    }

    .search input{
        outline: none;
        border: 2px solid #57cc8a;
        height: 40px;
    }
    .search .button {
        display: inline-block;
        position:relative;
    }
    .search .button button{
        outline: none;
        height: 40px;
        border: 0;
        width: 60px;
        background-color: #57A64A;
        margin: 0;
    }
    .search .icon{
        width: 22px;
        height: 22px;
    }
</style>
<div class="search">
    <input type="text" placeholder="search..." id="search-key" />
    <div class="button">
        <button onclick="search()">
            <svg t="1583982313567" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1271"
                 width="200" height="200" xmlns:xlink="http://www.w3.org/1999/xlink">
                <defs>
                    <style type="text/css"></style>
                </defs>
                <path d="M694.857143 475.428571q0-105.714286-75.142857-180.857142T438.857143 219.428571 258 294.571429 182.857143 475.428571t75.142857 180.857143T438.857143 731.428571t180.857143-75.142857T694.857143 475.428571z m292.571428 475.428572q0 29.714286-21.714285 51.428571t-51.428572 21.714286q-30.857143 0-51.428571-21.714286l-196-195.428571q-102.285714 70.857143-228 70.857143-81.714286 0-156.285714-31.714286t-128.571429-85.714286-85.714286-128.571428T36.571429 475.428571t31.714285-156.285714 85.714286-128.571428 128.571429-85.714286T438.857143 73.142857t156.285714 31.714286 128.571429 85.714286 85.714285 128.571428T841.142857 475.428571q0 125.714286-70.857143 228l196 196q21.142857 21.142857 21.142857 51.428572z"
                      p-id="1272" fill="#ffffff"></path>
            </svg>
        </button>
    </div>
</div>
<h1 id="search-tip" style="color: #57A64A;text-align: center;display: none;">搜索中，请稍后 ...</h1>
<br />
<div id="result"></div>

<script type="text/javascript">
    
    window.onload = function() {
        document.onkeydown = function(ev) {
            var event = ev || event
            if (event.keyCode === 13) {
                search()
            }
        }
    }

    
    function search() {
        var key = document.getElementById("search-key").value;
        if (key === "") {
            return;
        }
        

        
        document.getElementById("search-tip").innerText = "搜索中，请稍后 ...";
        document.getElementById("search-tip").style.display = "block";

        
        var el = document.getElementById('result');
        var childs = el.childNodes;
        for (var i = childs.length - 1; i >= 0; i--) {
            el.removeChild(childs[i]);
        }

        
        var xmltext = new XMLHttpRequest;
        xmltext.open("GET", "./index.xml", false);
        xmltext.send();
        var resp = xmltext.responseXML;
        var items = resp.getElementsByTagName("item");
        
        var i = 0;
        var haveResult = false;
        while (i < items.length) {
            var txt = items[i].getElementsByTagName("title")[0].innerHTML + items[i].getElementsByTagName("description")[0].innerHTML;
            var reg = new RegExp(key, "gi");
            if (txt.search(reg) > -1) {
                haveResult = true;
                var title = items[i].getElementsByTagName("title")[0].innerHTML;
                var link = items[i].getElementsByTagName("link")[0].innerHTML;
                var time = items[i].getElementsByTagName("pubDate")[0].innerHTML;
                var mark = items[i].getElementsByTagName("description")[0].innerHTML;
                addItem(title, link, time, mark)
            }
            i++;
        }
        if (!haveResult) {
            document.getElementById("search-tip").innerText = "搜索完毕，未发现结果 ...";
            document.getElementById("search-tip").style.display = "block";
        }
    }

    
    function addItem(title, link, time, mark) {
        document.getElementById("search-tip").style.display = "none";
        var tmpl = "<article class=\"post\" style=\"border-bottom: 1px solid #e6e6e6;\" >" +
            "<header class=\"post-header\">" +
            "<h1 class=\"post-title\"><a class=\"post-link\" href=\"" + link + "\" target=\"_blank\">" + title + "</a></h1>" +
            "<div class=\"post-meta\">" +
            " <span class=\"post-time\">" + time + "</span>" +
            "</div>" +
            " </header>" +
            "<div class=\"post-content\">" +
            "<div class=\"post-summary\">" + mark + "</div>" +
            "<div class=\"read-more\">" +
            "<a href=\"" + link + "\" class=\"read-more-link\" target=\"_blank\">阅读更多</a>" +
            "</div>" +
            " </div>" +
            "</article>"
        var div = document.createElement("div")
        div.innerHTML = tmpl;
        document.getElementById('result').appendChild(div)

    }
</script>
        
    <article class="post">
        <header class="post-header">
            <h1 class ="post-title">Kubernetes 的基本概念和术语 K8s Basic Concepts and Terminology</h1>
            <div class="post-meta">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
                    Jul 9, 2022
                </div>
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
                    2 min read
                </div><div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
                        <a class="tag" href="https://realjf.io/tags/k8s/">k8s</a></div></div>
        </header>
        <div class="post-content">
            <p>kubernetes的基本概念和术语大部分是围绕资源对象来说的，主要分为以下两类：</p>
<ul>
<li>某种资源的对象，如：节点（Node）、Pod、服务(Service)、存储卷（Volume）</li>
<li>与资源对象相关的事物与动作，如：标签（Label）、注解（Annotation）、命名空间（Namespace）、部署（Deployment）、HPA、PVC</li>
</ul>
<p>这里主要按照功能或用途分类，将其分为集群类、应用类、存储类及安全类</p>
<h3 id="集群类">集群类</h3>
<p>集群类表示一个由Master和Node组成的kubernetes集群</p>
<h4 id="master">Master</h4>
<p>Master指集群的控制节点，在每个kubernetes集群中都需要一个或一组被称为master的节点，来负责整个集群的管理和控制。
Master通常独占一个服务器（在高可用部署中至少是3台服务器），如果宕机，整个集群内容器应用的管理都将失效</p>
<p>Master上运行着以下关键进程：</p>
<ul>
<li>kubernetes API Server(kube-apiserver)：提供HTTP Restful API接口的主要服务，是kubernetes里对所有资源进行增删改查等操作的唯一入口，也是集群控制的入口进程</li>
<li>kubernetes Controller Manager(kube-controller-manager): kubernetes里所有资源对象的自动化控制中心</li>
<li>kubernetes Scheduler(kube-scheduler): 负责资源调度（Pod调度）的进程</li>
<li>etcd服务</li>
</ul>
<h4 id="node">Node</h4>
<p>kubernetes集群中除了master外其他服务器都被称为Node,Node是kubernetes集群中的工作负载节点，每个Node都会被master分配一些工作负载。当某个node宕机时，其上的工作负载会被master转移到其他Node上。</p>
<p>每个Node上都运行着以下关键进程：</p>
<ul>
<li>kubelet: 负责Pod对应容器的创建、启停等任务，同时与Master密切协作，实现集群管理的基本功能</li>
<li>kube-proxy: 实现kubernetes Service的通信与负载均衡机制的服务</li>
<li>容器运行时（如：Docker）:负责本机的容器创建和管理</li>
</ul>
<p>kubelet进程会定时向Master汇报自身的情报，例如：操作系统、主机cpu和内存使用情况，以及当前有哪些Pod在运行等，这样Master就可以获知每个Node上的资源使用情况，并实现高效均衡的资源调度策略</p>
<h4 id="命名空间">命名空间</h4>
<p>在很多情况下用于实现多租户的资源隔离，典型的一种思路就是给每个租户都分配一个命名空间，每个命名空间都是相互独立的存在，属于不同命名空间的资源对象从逻辑上相互隔离。</p>
<h3 id="应用类">应用类</h3>
<h4 id="service与pod">Service与Pod</h4>
<p>Service是指无状态服务，通常由多个程序副本提供服务，在特殊情况下，也可以是有状态的单实例服务，如mysql这种数据存储服务。</p>
<p>kubernetes的Service具有一个全局唯一的虚拟ClusterIP地址，Service一旦创建，kubernetes就会自动为其分配一个可用的ClusterIP地址，而且在Service的整个生命周期中，它的ClusterIP地址都不会改变，客户端可以通过这个虚拟IP地址+服务的端口直接访问该服务，再通过部署kubernetes集群的DNS服务，就可以实现Service Name(域名)到ClusterIP地址的DNS映射功能，我们只要使用服务的名称（DNS名称）即可完成到目标服务的访问请求。</p>
<p>Pod是最重要的基本概念之一，每个Pod都有一个特殊的被称为根容器的Pause容器，Pause容器对应的镜像属于kubernetes平台的一部分，除了Pause容器，每个Pod都还包含一个或多个紧密相关的用户业务容器。</p>
<p>Pod特殊结构原因：</p>
<ul>
<li>为多进程之间的协作提供抽象模型，使用Pod作为基本调度、复制等管理工作的最小单位，让多个应用进程能一起有效地调度和伸缩</li>
<li>Pod里的多个业务容器共享Pause容器的IP，共享pause容器挂接的volume，这样既简化了密切关联的业务容器之间的通信问题，也很好地解决了它们之间的文件共享问题</li>
</ul>
<p>kubernetes为每个Pod都分配了唯一的IP地址，称为Pod IP，一个Pod里的多个容器共享Pod IP地址。
kubernetes要求底层网络支持集群内任意两个Pod之间的直接通信，这通常采用虚拟二层网络技术实现，如：flannel、open vSwitch等，因此，在kubernetes里，一个Pod里的容器与另外主机上的Pod容器能够直接通信。</p>
<p>Pod有两种：</p>
<ul>
<li>普通的Pod，一旦创建，就会被放入etcd中存储，随后被master调度到某个具体的Node上并绑定</li>
<li>静态Pod，静态Pod并没有存放在kubernetes中etcd中，而是被存放在某个具体的Node上的一个具体文件中，并且只能在此Node上启动、运行。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myweb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myweb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myweb</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">kubeguide/tomcat-app:v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><p>Pod的IP加上这里的容器端口组成了一个新的概念——Endpoint，代表此Pod里的一个服务进程的对外通信地址。一个Pod也存在具有多个Endpoint的情况</p>
<h4 id="label与标签选择器">Label与标签选择器</h4>
<p>一个Label是一个key=value的键值对，一个资源对象可以定义任意数量的Label</p>
<p>给某个资源对象定义一个Label，就相当于给它打上了一个标签，随后可以通过Label Selector查询和筛选拥有某些Label的资源对象</p>
<h4 id="pod与deployment">Pod与Deployment</h4>
<p>Deployment可以看成是Pod的模板，用于实现对Pod的控制，其主要使用场景如下：</p>
<ul>
<li>创建一个Deployment对象来完成相应Pod副本数量的创建</li>
<li>检查Deployment状态确认部署动作是否完成</li>
<li>更新Deployment以创建新的Pod</li>
<li>扩展Deployment以应对高负载</li>
</ul>
<h4 id="service的clusterip地址">Service的ClusterIP地址</h4>
<p>kubernetes内部在每个Node上都运行了一套全局的虚拟负载均衡器，自动注入并自动实时更新集群中所有Service的路由表，通过iptables或IPVS机制，把对Service的请求转发到其后端对应的某个Pod实例上，并在内部实现服务的负载均衡与会话保持机制。</p>
<p>ClusterIP是虚拟IP地址的原因：</p>
<ul>
<li>ClusterIP地址仅仅作用于kubernetes Service这个对象，并由kubernetes管理和分配IP地址，与Node和Master所在地屋里网络完全无关</li>
<li>因为没有一个实体网络对象来响应，所以ClusterIP地址无法被ping通，ClusterIP地址只能与Service Port组成一个具体的服务访问端点，单独的ClusterIP不具备TCP/IP通信的基础</li>
<li>ClusterIP属于kubernetes集群这个封闭的空间，集群外的节点要访问这个通信端口，则需要做一些额外的工作</li>
</ul>
<p>除了正常的Service，还有一种特殊Service——Headless Service，只要在Service的定义中设置了clusterIP: None，就定义了一个Headless Service，它与普通Service的关键区别在于它没有ClusterIP地址，如果解析Headless Service的DNS域名，则返回的是该Service对应的全部Pod的Endpoint列表，这意味着客户端是直接跟后端的Pod建立TCP/IP连接进行通信的，没有通过虚拟ClusterIP地址进行转发，因此通信性能最高，等同于原生网络通信</p>
<h4 id="service的外网访问问题">Service的外网访问问题</h4>
<p>如何在kubernetes集群外访问应用服务呢？
首先弄明白kubernetes的三种IP，分别是：</p>
<ul>
<li>Node IP: Node的IP地址</li>
<li>Pod IP: Pod的IP地址</li>
<li>Service IP: Service的IP地址</li>
</ul>
<p>Node IP是kubernetes集群中每个节点的物理网卡的IP地址，是一个真实存在的物理网络，所有属于这个网络的服务器都能通过这个网络直接通信，说明kubernetes集群外地节点访问kubernetes集群内的某个节点或者TCP/IP服务时，都必须通过Node IP通信</p>
<p>Pod IP是每个Pod的IP地址，在使用docker作为容器支持引擎下，它是Docker Engine根据docker0网桥的IP地址段进行分配的，通常是一个虚拟二层网络。kubernetes中一个Pod里的容器访问另外一个Pod里的容器时，就是通过Pod IP所在地虚拟二层网络进行通信的，而真实的TCP/IP流量是通过Node IP所在的物理网卡流出的</p>
<p>Service的ClusterIP地址属于集群内的地址，无法在集群外直接使用，为了解决这个问题，kubernetes引入了NodePort这个概念，NodePort也是解决集群外的应用访问集群内服务的直接、有效的常见做法。</p>
<p>设置了nodePort后，集群外就可以直接通过<!-- raw HTML omitted -->:<!-- raw HTML omitted -->进行访问了</p>
<p>NodePort的实现方式是：在kubernetes集群的每个Node上都为需要外部访问的Service开启一个对应的TCP监听端口，外部系统只要用任意一个Node的IP地址+NodePort端口号即可访问此服务。</p>
<p><strong>NodePort还没有完全解决外部访问Service的所有问题</strong>，比如负载均衡问题。</p>
<p>负载均衡器独立于kubernetes集群之外，可以用硬件或软件实现，如HAProxy或Nginx，对于每个Service，我们通常需要配置一个对应的负载均衡器实例来转发流量到后端的Node上，kubernetes提供了自动化解决方案。如GCE公有云上，只需要把Service的type=NodePort改为type=LoadBalancer，kubernetes就会自动创建一个对应的负载均衡器实例并返回它的IP地址供外部客户端使用。</p>
<p>由于端口是有限的物理资源，那能不能让多个Service共用一个对外端口呢？
Ingress就是解决该问题的。其实现机制可以理解为基于Nginx的支持虚拟主机的HTTP代理</p>
<h4 id="有状态的应用集群">有状态的应用集群</h4>
<p>Deployment对象用来实现无状态服务的多副本自动控制功能，那么有状态的服务呢？
这些一开始是依赖StatefulSet解决的，但后来发现StatefulSet还是不够通用和强大，所以后面又出现了kubernetes Operator。</p>
<p>有状态应用一般有如下特殊共性：</p>
<ul>
<li>每个节点都有固定的身份ID，通过这个ID，集群中的成员可以相互发现并通信</li>
<li>集群的规模是比较固定的，集群规模不能随意变动</li>
<li>集群中的每个节点都是有状态的，通常会持久化数据到永久存储中，每个节点在重启后都需要使用原有的持久化数据</li>
<li>集群中成员节点的启动顺序通常也是确定的</li>
<li>如果磁盘损坏，则集群的某个节点无法正常运行，集群功能受损</li>
</ul>
<p>为了解决有状态集群的这种复杂的特殊应用的建模，kubernetes引入了StatefulSet，其本质上是Deployment/RC的一个特殊变种，特性如下：</p>
<ul>
<li>StatefulSet里的每个Pod都有稳定、唯一的网络标识，可以用来发现集群内的其它成员</li>
<li>StatefulSet控制的Pod副本的启停顺序是受控的</li>
<li>StatefulSet里的Pod采用稳定的持久化存储卷，通过PV或PVC来实现，删除Pod时默认不会删除与StatefulSet相关的存储卷</li>
</ul>
<p>StatefulSet除了要与PV卷捆绑使用，以存储Pod的状态数据，还要与Headless Service配合使用，即在每个StatefulSet定义中都要声明它属于哪个Headless Service。
StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod实例都创建了一个DNS域名，这个域名格式如下:</p>
<pre tabindex="0"><code>$(podname).$(headless service name)
</code></pre><p>StatefulSet的建模能力有限，所以有了后来的kubernetes Operator框架和众多Operator实现，
kubernetes平台开发者利用kubernetes Operator框架提供的API,可以更方便地开发一个类似StatefulSet的控制器。</p>
<h4 id="批处理应用">批处理应用</h4>
<p>批处理应用的特点是一个或多个进程处理一组数据，在这组数据都处理完成后，批处理任务自动结束，其对应的资源对象是Job。</p>
<p>除了Job，kubernetes还引入了CronJob，可以周期性地执行某个任务</p>
<h4 id="应用的配置问题">应用的配置问题</h4>
<p>如何解决应用需要在不同的环境中修改配置的问题呢？这就需要ConfigMap和Secret两个对象。</p>
<p>ConfigMap就是保存配置项的一个Map，是分布式系统中配置中心的独特实现之一。</p>
<p>具体使用如下：</p>
<ul>
<li>用户将配置文件的内容保存到ConfigMap中，文件名可作为key，value就是整个文件袋内容，多个配置文件都可被放入同一个ConfigMap</li>
<li>在建模用户应用时，在Pod里将ConfigMap定义为特殊的Volume进行挂载，在Pod被调度到某个具体Node上时，ConfigMap里的配置文件会被自动还原到本地目录下，然后映射到Pod里指定的配置目录下，这样用户的程序就可以无感知地读取配置了</li>
<li>在ConfigMap的内容发生修改后，kubernetes会自动重新获取ConfigMap的内容，并在目标节点上更新对应的文件</li>
</ul>
<p>Secret是用来解决对敏感信息的配置问题，如密码等</p>
<h4 id="应用的运维问题">应用的运维问题</h4>
<p>HPA：Pod横向自动扩容，通过跟踪分析指定Deployment控制的所有目标Pod的负载变化情况，来确定是否需要有针对性地调整目标Pod的副本数量，这就是HPA的实现原理。</p>
<p>VPA：垂直Pod自动扩缩容，它根据容器资源使用率自动推测并设置Pod合理的CPU和内存的需求指标，从而更加精准地调度Pod，实现整体上节省集群资源的目标</p>
<h3 id="存储类">存储类</h3>
<p>存储类资源对象包括：Volume、Persistent Volume、PVC和StorageClass</p>
<p>Volume是Pod中能够被多个容器访问的共享目录。</p>
<p>kubernetes提供了丰富的Volume类型供容器使用，如临时目录，宿主机目录，共享存储等</p>
<h4 id="emptydir">emptyDir</h4>
<p>一个emptyDir是在Pod分配到Node时创建的，它的初始内容为空，并且无需指定宿主机上对应的目录文件，因为这是kubernetes自动分配的一个目录，当Pod从Node上移除时，emptyDir中的数据也被<strong>永久移出</strong>。</p>
<p>emptyDir的一些用途：</p>
<ul>
<li>临时空间</li>
<li>长时间任务执行过程中使用的临时目录</li>
<li>一个容器需要从另一个容器中获取数据的目录</li>
</ul>
<p>默认情况下，emptyDir使用的是节点的存储介质，还可以使用内存</p>
<h4 id="hostpath">hostPath</h4>
<p>hostPath为在Pod上挂载宿主机上的文件或目录，可以用于如下场景：</p>
<ul>
<li>在容器应用程序生成的日志文件需要永久保存时</li>
<li>需要访问宿主机上docker引擎内部数据结构的容器应用时</li>
</ul>
<h4 id="公有云volume">公有云Volume</h4>
<h4 id="其他类型的volume">其他类型的Volume</h4>
<ul>
<li>iscsi：将iSCSI存储设备上的目录挂载到Pod中</li>
<li>nfs: 将NFS Server上的目录挂载到Pod中</li>
<li>glusterfs: 将开源GlusterFS网络文件系统的目录挂载到Pod中</li>
<li>rbd: 将Ceph块设备共享存储挂载到Pod中</li>
<li>gitRepo: 通过挂载一个空目录，并从git库克隆一个git repository以供Pod使用</li>
<li>configmap: 将配置数据挂载为容器内的文件</li>
<li>secret: 将Secret数据挂载为容器内的文件</li>
</ul>
<p><strong>动态存储管理</strong>
Volume属于静态管理的存储，即我们需要事先定义每个Volume，然后将其挂载到Pod中去用，这种方式存在很多弊端。所以kubernetes发展了存储动态化新机制，其核心对象有三个：Persistent Volume(PV)、StorageClass、PVC。</p>
<p>PV表示由系统动态创建的一个存储卷，可以理解为kubernetes集群中某个网络存储对应的一块存储，它不是被定义在Pod上，而是独立于Pod之外定义的。</p>
<p>PV支持的存储系统很多种，那系统怎么知道从哪个存储系统中创建什么规格的PV存储卷呢?这就需要StorageClass和PVC。</p>
<p>StorageClass用来描述和定义某种存储系统的特征</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">standard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">kubernetes.io/aws-ebs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">gp2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">allowVolumeExpansion</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mountOptions</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeBindingMode</span>: <span style="color:#ae81ff">Immediate</span>
</span></span></code></pre></div><ul>
<li>provisioner代表了创建PV的第三方存储插件</li>
<li>parameters是创建PV时的必要参数</li>
<li>reclaimPolicy是PV回收策略，回收策略包括删除或保留</li>
</ul>
<p>典型的PVC定义如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">claim1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">standard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">30Gi</span>
</span></span></code></pre></div><p>PVC表示应用希望申请的PV规格，其中重要的属性包括accessModes(存储访问模式)、StorageClassName及resources（存储的具体规格）</p>
<p>只要在Pod里引入PVC即可达到使用目的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tomcat:8.5.38-jre8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcatedata</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#34;/data&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcatedata</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">claim1</span>
</span></span></code></pre></div><h3 id="安全类">安全类</h3>
<p>基于角色的访问控制权限系统——RBAC（Role-Based Access Control）</p>
<p>默认情况下，kubernetes在每个命名空间中都会创建一个默认的名称为default的Service Account，因此Service Account是不能全局使用的，只能被它所在命名空间中的Pod使用。</p>
<p>Role作用于局限于某个命名空间的角色
ClusterRole作用于整个kubernetes集群范围内的角色</p>
<p>创建好了角色，就需要通过RoleBinding和ClusterRoleBinding来绑定某个具体用户了。</p>
<p>NetworkPolicy：它是网络安全相关的资源对象，用于解决用户应用之间的网络隔离和授权问题。</p>

        </div>
        <div id="disqus_thread"></div>
<script>

    

    

    (function() { 
        var d = document, s = d.createElement('script');
        s.src = 'https://realjf.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </article>
    

    <div class="article-related">
        <hr/>
        <fieldset>
            <legend>相关阅读推荐（See Also）</legend>
            <ul>
                
                    <li><a href="/k8s/k8s-csi-plugin-in-action/">K8s CSI插件开发实战 K8s CSI Plugin Development in Action</a></li>
                
                    <li><a href="/k8s/k8s-csi-plugin-development/">K8s CSI插件开发简介 K8s CSI Plugin Development Overview</a></li>
                
                    <li><a href="/k8s/k8s-build-and-deploy-a-basic-operator/">构建一个基础K8s Operator| Build and Deploy a Basic Operator</a></li>
                
                    <li><a href="/k8s/kubeadm-install-k8s/">使用kubeadm工具安装 kubernetes Use Kubeadm Install K8s</a></li>
                
                    <li><a href="/k8s/operator-pattern/">k8s 之 Operator模式 Operator Pattern</a></li>
                
            </ul>
        </fieldset>
    </div>


    
<aside class="aside-menu">
    <div class="aside-bar-icon">
        <i class="fa fa-list-alt"></i>
    </div>
    <ul>
        
        
            
                <li>
                    <a href="/" title="首页">
                        
                        <span>首页</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="/posts/" title="归档">
                        
                        <span>归档</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="/tags/" title="标签">
                        
                        <span>标签</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="/categories/" title="分类">
                        
                        <span>分类</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="/series/" title="系列">
                        
                        <span>系列</span>
                    </a>
                </li>
            
        
    </ul>
</aside>

    

    </main>
    <aside class="sider">
    <div>
        <h2>书籍</h2>
    </div>
    <ul>
        <li>
            <a href="https://premake.realjf.io" title="premake" target="_blank">
                <span>premake 中文手册</span>
            </a>
        </li>
        <li>
            <a href="https://gltf.realjf.io" title="glTF" target="_blank">
                <span>glTF 中文手册</span>
            </a>
        </li>
        <li>
            <a href="https://box2d.realjf.io" title="Box2D" target="_blank">
                <span>Box2D 中文手册</span>
            </a>
        </li>
        <li>
            <a href="https://gdb.realjf.io" title="gdb" target="_blank">
                <span>gdb 中文手册</span>
            </a>
        </li>
    </ul>
</aside>

    <div class="app-footer">
        <span>
  powered by <a target="_blank" href="https://gohugo.io">hugo</a> &nbsp;&nbsp;&nbsp;
   &copy; 2019 - 2021 <a href="https://realjf.io">realjf.io</a>
</span>
    </div>
    <script id="dsq-count-scr" src="//realjf.disqus.com/count.js" async></script>
    <script type="text/javascript" src="./js/highlight.min.js"></script>
</body>

</html>